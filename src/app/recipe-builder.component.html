<div class="recipe-builder" role="region" aria-label="Recipe Builder">
  <h2>Recipe Builder</h2>

  <!-- Available ingredients -->
  <section class="available" role="region" aria-labelledby="available-ingredients-heading">
    <h3 id="available-ingredients-heading">Available Ingredients</h3>

    @if ((ingredients() || []).length === 0) {
      <div class="empty">No ingredients available.</div>
    }

    @if ((ingredients() || []).length > 0) {
      <div class="categories" role="listbox" aria-multiselectable="true" aria-describedby="available-ingredients-desc">
        <p id="available-ingredients-desc" class="visually-hidden">Use buttons below to add ingredients to current recipe. Selected items are indicated.</p>
      @if (groupedIngredients().protein.length) {
        <h4 id="protein-heading">Protein</h4>
        <div class="items" role="group" aria-labelledby="protein-heading">
          @for (ing of groupedIngredients().protein; track ing.id) {
          <button
            class="ingredient"
            (click)="addIngredient(ing.id)"
            [class.selected]="isIngredientSelected(ing.id)"
            type="button"
            role="option"
            [attr.aria-selected]="isIngredientSelected(ing.id)"
            [attr.aria-label]="ing.name + ' ' + ing.calories + ' calories'"
          >
            <div class="name">{{ing.name}}</div>
            <div class="meta"><span class="badge badge-soft">{{ing.calories}} cal</span></div>
          </button>
          }
        </div>
      }

      @if (groupedIngredients().grain.length) {
        <h4 id="grain-heading">Grain</h4>
        <div class="items" role="group" aria-labelledby="grain-heading">
          @for (ing of groupedIngredients().grain; track ing.id) {
          <button
            class="ingredient"
            (click)="addIngredient(ing.id)"
            [class.selected]="isIngredientSelected(ing.id)"
            type="button"
            role="option"
            [attr.aria-selected]="isIngredientSelected(ing.id)"
            [attr.aria-label]="ing.name + ' ' + ing.calories + ' calories'"
          >
            <div class="name">{{ing.name}}</div>
            <div class="meta"><span class="badge badge-soft">{{ing.calories}} cal</span></div>
          </button>
          }
        </div>
      }

      @if (groupedIngredients().vegetable.length) {
        <h4 id="vegetable-heading">Vegetable</h4>
        <div class="items" role="group" aria-labelledby="vegetable-heading">
          @for (ing of groupedIngredients().vegetable; track ing.id) {
          <button
            class="ingredient"
            (click)="addIngredient(ing.id)"
            [class.selected]="isIngredientSelected(ing.id)"
            type="button"
            role="option"
            [attr.aria-selected]="isIngredientSelected(ing.id)"
            [attr.aria-label]="ing.name + ' ' + ing.calories + ' calories'"
          >
            <div class="name">{{ing.name}}</div>
            <div class="meta"><span class="badge badge-soft">{{ing.calories}} cal</span></div>
          </button>
          }
        </div>
      }
      </div>
    }
  </section>

  <!-- Current recipe -->
  <section class="current" role="region" aria-labelledby="current-recipe-heading">
    <h3 id="current-recipe-heading">Current Recipe</h3>

    @if (selectedIngredients().length > 0) {
      <div class="selected-list">
      <ul role="list">
        @for (id of selectedIngredients(); track id) {
        <li role="listitem">
          <span class="ing-name">
            {{ getIngredientName(id) }}
          </span>
          <span class="ing-cal">
            {{ getIngredientCalories(id) }} cal
          </span>
          <button class="remove" (click)="removeIngredient(id)" type="button" aria-label="Remove {{ getIngredientName(id) }} from recipe">Remove</button>
        </li>
        }
      </ul>

      <form class="summary" [formGroup]="recipeForm" (ngSubmit)="onSubmit()" aria-describedby="totals" novalidate>
        <label for="recipeNameInput">
          Recipe Name <span aria-hidden="true" class="required-asterisk">*</span>
        </label>
        <input id="recipeNameInput" formControlName="recipeName" (focus)="onNameFocus()" (blur)="onNameBlur()" aria-required="true" [attr.aria-invalid]="recipeForm.get('recipeName')?.invalid || null" />

        @if ((nameFocused() || recipeForm.get('recipeName')?.touched) && recipeForm.get('recipeName')?.invalid) {
          <div class="validation" role="alert" aria-live="assertive">
            @if (recipeForm.get('recipeName')?.errors?.['required']) {
              <div class="error">* Recipe name is required.</div>
            }
            @if (recipeForm.get('recipeName')?.errors?.['minlength']) {
              <div class="error">* Recipe name must be at least 3 characters.</div>
            }
          </div>
        }

        <div id="totals" class="totals" aria-live="polite">Total Calories: <span class="badge badge-accent">{{ totalCalories() }}</span></div>

        <div class="actions">
          <button
            class="btn btn-primary save"
            type="submit"
            [disabled]="recipeForm.invalid || selectedIngredients().length === 0"
          >Save Recipe</button>

          <button class="btn btn-muted clear" (click)="clearCurrentRecipe()" type="button">Clear</button>
        </div>
      </form>
      </div>
    } @else {
      <div class="empty" role="status" aria-live="polite">No ingredients selected yet.</div>
    }
  </section>

  <!-- Saved recipes -->
  <section class="saved" role="region" aria-labelledby="saved-recipes-heading">
    <h3 id="saved-recipes-heading">Saved Recipes</h3>

    @if (savedRecipes().length === 0) {
      <div class="empty" role="status" aria-live="polite">No saved recipes yet.</div>
    }

    @if (savedRecipes().length > 0) {
      <ul role="list">
      @for (r of savedRecipes(); track r.id) {
      <li role="listitem">
        <div class="saved-name">{{r.name}}</div>
        <div class="saved-meta">{{r.ingredients.length}} ingredients â€¢ {{r.totalCalories}} cal</div>
        <div>
          <button type="button" class="btn btn-danger" (click)="removeSavedRecipe(r.id)" aria-label="Delete saved recipe {{r.name}}">Remove</button>
        </div>
      </li>
      }
      </ul>
    }
  </section>
</div>
